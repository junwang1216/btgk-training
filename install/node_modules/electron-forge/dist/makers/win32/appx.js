'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createDefaultCertificate = exports.isSupportedOnCurrentPlatform = undefined;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _bluebird = require('bluebird');

let createDefaultCertificate = exports.createDefaultCertificate = (() => {
  var _ref2 = (0, _bluebird.coroutine)(function* (publisherName, { certFilePath, certFileName, install, program }) {
    const makeCertOptions = {
      publisherName,
      certFilePath: certFilePath || process.cwd(),
      certFileName: certFileName || 'default',
      install: typeof install === 'boolean' ? install : false,
      program: program || { windowsKit: _path2.default.dirname(findSdkTool('makecert.exe')) }
    };

    if (!(0, _sign.isValidPublisherName)(publisherName)) {
      throw new Error(`Received invalid publisher name: '${publisherName}' did not conform to X.500 distinguished name syntax for MakeCert.`);
    }

    return yield (0, _sign.makeCert)(makeCertOptions);
  });

  return function createDefaultCertificate(_x, _x2) {
    return _ref2.apply(this, arguments);
  };
})();

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _resolveCommand = require('cross-spawn/lib/util/resolveCommand');

var _resolveCommand2 = _interopRequireDefault(_resolveCommand);

var _electronWindowsStore = require('electron-windows-store');

var _electronWindowsStore2 = _interopRequireDefault(_electronWindowsStore);

var _sign = require('electron-windows-store/lib/sign');

var _configFn = require('../../util/config-fn');

var _configFn2 = _interopRequireDefault(_configFn);

var _authorName = require('../../util/author-name');

var _authorName2 = _interopRequireDefault(_authorName);

var _ensureOutput = require('../../util/ensure-output');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// electron-windows-store doesn't set its 'os' field even though it only runs on
// win32
const isSupportedOnCurrentPlatform = exports.isSupportedOnCurrentPlatform = (() => {
  var _ref = (0, _bluebird.coroutine)(function* () {
    return process.platform === 'win32';
  });

  return function isSupportedOnCurrentPlatform() {
    return _ref.apply(this, arguments);
  };
})();

// NB: This is not a typo, we require AppXs to be built on 64-bit
// but if we're running in a 32-bit node.js process, we're going to
// be Wow64 redirected
const windowsSdkPath = process.arch === 'x64' ? 'C:\\Program Files (x86)\\Windows Kits\\10\\bin\\x64' : 'C:\\Program Files\\Windows Kits\\10\\bin\\x64';

function findSdkTool(exe) {
  let sdkTool = _path2.default.join(windowsSdkPath, exe);
  if (!_fs2.default.existsSync(sdkTool)) {
    sdkTool = (0, _resolveCommand2.default)(exe, true);
  }

  if (!_fs2.default.existsSync(sdkTool)) {
    throw new Error(`Can't find ${exe} in PATH. You probably need to install the Windows SDK.`);
  }

  return sdkTool;
}

function getDistinguishedNameFromAuthor(author) {
  return `CN=${(0, _authorName2.default)(author)}`;
}

exports.default = (() => {
  var _ref3 = (0, _bluebird.coroutine)(function* ({ dir, appName, targetArch, forgeConfig, packageJSON }) {
    const outPath = _path2.default.resolve(dir, `../make/appx/${targetArch}`);
    yield (0, _ensureOutput.ensureDirectory)(outPath);

    const userConfig = (0, _configFn2.default)(forgeConfig.windowsStoreConfig, targetArch);

    const opts = (0, _assign2.default)({
      publisher: getDistinguishedNameFromAuthor(packageJSON.author),
      flatten: false,
      deploy: false,
      packageVersion: `${packageJSON.version}.0`,
      packageName: appName.replace(/-/g, ''),
      packageDisplayName: appName,
      packageDescription: packageJSON.description || appName,
      packageExecutable: `app\\${appName}.exe`,
      windowsKit: userConfig.windowsKit || _path2.default.dirname(findSdkTool('makeappx.exe'))
    }, userConfig, {
      inputDirectory: dir,
      outputDirectory: outPath
    });

    if (!opts.publisher) {
      throw 'Please set config.forge.windowsStoreConfig.publisher or author.name in package.json for the appx target';
    }

    if (!opts.devCert) {
      opts.devCert = yield createDefaultCertificate(opts.publisher, { certFilePath: outPath, program: opts });
    }

    if (opts.packageVersion.match(/-/)) {
      if (opts.makeVersionWinStoreCompatible) {
        const noBeta = opts.packageVersion.replace(/-.*/, '');
        opts.packageVersion = `${noBeta}.0`;
      } else {
        const err = "Windows Store version numbers don't support semver beta tags. To" + 'automatically fix this, set makeVersionWinStoreCompatible to true or ' + 'explicitly set packageVersion to a version of the format X.Y.Z.A';

        throw new Error(err);
      }
    }

    delete opts.makeVersionWinStoreCompatible;

    yield (0, _electronWindowsStore2.default)(opts);

    return [_path2.default.resolve(outPath, `${opts.packageName}.appx`)];
  });

  return function (_x3) {
    return _ref3.apply(this, arguments);
  };
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1ha2Vycy93aW4zMi9hcHB4LmpzIl0sIm5hbWVzIjpbInB1Ymxpc2hlck5hbWUiLCJjZXJ0RmlsZVBhdGgiLCJjZXJ0RmlsZU5hbWUiLCJpbnN0YWxsIiwicHJvZ3JhbSIsIm1ha2VDZXJ0T3B0aW9ucyIsInByb2Nlc3MiLCJjd2QiLCJ3aW5kb3dzS2l0IiwiZGlybmFtZSIsImZpbmRTZGtUb29sIiwiRXJyb3IiLCJjcmVhdGVEZWZhdWx0Q2VydGlmaWNhdGUiLCJpc1N1cHBvcnRlZE9uQ3VycmVudFBsYXRmb3JtIiwicGxhdGZvcm0iLCJ3aW5kb3dzU2RrUGF0aCIsImFyY2giLCJleGUiLCJzZGtUb29sIiwiam9pbiIsImV4aXN0c1N5bmMiLCJnZXREaXN0aW5ndWlzaGVkTmFtZUZyb21BdXRob3IiLCJhdXRob3IiLCJkaXIiLCJhcHBOYW1lIiwidGFyZ2V0QXJjaCIsImZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJvdXRQYXRoIiwicmVzb2x2ZSIsInVzZXJDb25maWciLCJ3aW5kb3dzU3RvcmVDb25maWciLCJvcHRzIiwicHVibGlzaGVyIiwiZmxhdHRlbiIsImRlcGxveSIsInBhY2thZ2VWZXJzaW9uIiwidmVyc2lvbiIsInBhY2thZ2VOYW1lIiwicmVwbGFjZSIsInBhY2thZ2VEaXNwbGF5TmFtZSIsInBhY2thZ2VEZXNjcmlwdGlvbiIsImRlc2NyaXB0aW9uIiwicGFja2FnZUV4ZWN1dGFibGUiLCJpbnB1dERpcmVjdG9yeSIsIm91dHB1dERpcmVjdG9yeSIsImRldkNlcnQiLCJtYXRjaCIsIm1ha2VWZXJzaW9uV2luU3RvcmVDb21wYXRpYmxlIiwibm9CZXRhIiwiZXJyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozt1Q0FrQ08sV0FBd0NBLGFBQXhDLEVBQXVELEVBQUVDLFlBQUYsRUFBZ0JDLFlBQWhCLEVBQThCQyxPQUE5QixFQUF1Q0MsT0FBdkMsRUFBdkQsRUFBeUc7QUFDOUcsVUFBTUMsa0JBQWtCO0FBQ3RCTCxtQkFEc0I7QUFF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LFNBQTlCLEVBQXlDLEVBQUVoQyxjQUFjMkIsT0FBaEIsRUFBeUJ4QixTQUFTNEIsSUFBbEMsRUFBekMsQ0FBckI7QUFDRDs7QUFFRCxRQUFJQSxLQUFLSSxjQUFMLENBQW9CVyxLQUFwQixDQUEwQixHQUExQixDQUFKLEVBQW9DO0FBQ2xDLFVBQUlmLEtBQUtnQiw2QkFBVCxFQUF3QztBQUN0QyxjQUFNQyxTQUFTakIsS0FBS0ksY0FBTCxDQUFvQkcsT0FBcEIsQ0FBNEIsS0FBNUIsRUFBbUMsRUFBbkMsQ0FBZjtBQUNBUCxhQUFLSSxjQUFMLEdBQXVCLEdBQUVhLE1BQU8sSUFBaEM7QUFDRCxPQUhELE1BR087QUFDTCxjQUFNQyxNQUFNLHFFQUNWLHVFQURVLEdBRVYsa0VBRkY7O0FBSUEsY0FBTSxJQUFJdkMsS0FBSixDQUFVdUMsR0FBVixDQUFOO0FBQ0Q7QUFDRjs7QUFFRCxXQUFPbEIsS0FBS2dCLDZCQUFaOztBQUVBLFVBQU0sb0NBQWFoQixJQUFiLENBQU47O0FBRUEsV0FBTyxDQUFDLGVBQUtILE9BQUwsQ0FBYUQsT0FBYixFQUF1QixHQUFFSSxLQUFLTSxXQUFZLE9BQTFDLENBQUQsQ0FBUDtBQUNELEciLCJmaWxlIjoibWFrZXJzL3dpbjMyL2FwcHguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgcmVzb2x2ZUNvbW1hbmQgZnJvbSAnY3Jvc3Mtc3Bhd24vbGliL3V0aWwvcmVzb2x2ZUNvbW1hbmQnO1xuaW1wb3J0IHdpbmRvd3NTdG9yZSBmcm9tICdlbGVjdHJvbi13aW5kb3dzLXN0b3JlJztcbmltcG9ydCB7IGlzVmFsaWRQdWJsaXNoZXJOYW1lLCBtYWtlQ2VydCB9IGZyb20gJ2VsZWN0cm9uLXdpbmRvd3Mtc3RvcmUvbGliL3NpZ24nO1xuXG5pbXBvcnQgY29uZmlnRm4gZnJvbSAnLi4vLi4vdXRpbC9jb25maWctZm4nO1xuaW1wb3J0IGdldE5hbWVGcm9tQXV0aG9yIGZyb20gJy4uLy4uL3V0aWwvYXV0aG9yLW5hbWUnO1xuaW1wb3J0IHsgZW5zdXJlRGlyZWN0b3J5IH0gZnJvbSAnLi4vLi4vdXRpbC9lbnN1cmUtb3V0cHV0JztcblxuLy8gZWxlY3Ryb24td2luZG93cy1zdG9yZSBkb2Vzbid0IHNldCBpdHMgJ29zJyBmaWVsZCBldmVuIHRob3VnaCBpdCBvbmx5IHJ1bnMgb25cbi8vIHdpbjMyXG5leHBvcnQgY29uc3QgaXNTdXBwb3J0ZWRPbkN1cnJlbnRQbGF0Zm9ybSA9IGFzeW5jICgpID0+IHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMic7XG5cbi8vIE5COiBUaGlzIGlzIG5vdCBhIHR5cG8sIHdlIHJlcXVpcmUgQXBwWHMgdG8gYmUgYnVpbHQgb24gNjQtYml0XG4vLyBidXQgaWYgd2UncmUgcnVubmluZyBpbiBhIDMyLWJpdCBub2RlLmpzIHByb2Nlc3MsIHdlJ3JlIGdvaW5nIHRvXG4vLyBiZSBXb3c2NCByZWRpcmVjdGVkXG5jb25zdCB3aW5kb3dzU2RrUGF0aCA9IHByb2Nlc3MuYXJjaCA9PT0gJ3g2NCcgP1xuICAnQzpcXFxcUHJvZ3JhbSBGaWxlcyAoeDg2KVxcXFxXaW5kb3dzIEtpdHNcXFxcMTBcXFxcYmluXFxcXHg2NCcgOlxuICAnQzpcXFxcUHJvZ3JhbSBGaWxlc1xcXFxXaW5kb3dzIEtpdHNcXFxcMTBcXFxcYmluXFxcXHg2NCc7XG5cbmZ1bmN0aW9uIGZpbmRTZGtUb29sKGV4ZSkge1xuICBsZXQgc2RrVG9vbCA9IHBhdGguam9pbih3aW5kb3dzU2RrUGF0aCwgZXhlKTtcbiAgaWYgKCFmcy5leGlzdHNTeW5jKHNka1Rvb2wpKSB7XG4gICAgc2RrVG9vbCA9IHJlc29sdmVDb21tYW5kKGV4ZSwgdHJ1ZSk7XG4gIH1cblxuICBpZiAoIWZzLmV4aXN0c1N5bmMoc2RrVG9vbCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGZpbmQgJHtleGV9IGluIFBBVEguIFlvdSBwcm9iYWJseSBuZWVkIHRvIGluc3RhbGwgdGhlIFdpbmRvd3MgU0RLLmApO1xuICB9XG5cbiAgcmV0dXJuIHNka1Rvb2w7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVEZWZhdWx0Q2VydGlmaWNhdGUocHVibGlzaGVyTmFtZSwgeyBjZXJ0RmlsZVBhdGgsIGNlcnRGaWxlTmFtZSwgaW5zdGFsbCwgcHJvZ3JhbSB9KSB7XG4gIGNvbnN0IG1ha2VDZXJ0T3B0aW9ucyA9IHtcbiAgICBwdWJsaXNoZXJOYW1lLFxuICAgIGNlcnRGaWxlUGF0aDogY2VydEZpbGVQYXRoIHx8IHByb2Nlc3MuY3dkKCksXG4gICAgY2VydEZpbGVOYW1lOiBjZXJ0RmlsZU5hbWUgfHwgJ2RlZmF1bHQnLFxuICAgIGluc3RhbGw6IHR5cGVvZiBpbnN0YWxsID09PSAnYm9vbGVhbicgPyBpbnN0YWxsIDogZmFsc2UsXG4gICAgcHJvZ3JhbTogcHJvZ3JhbSB8fCB7IHdpbmRvd3NLaXQ6IHBhdGguZGlybmFtZShmaW5kU2RrVG9vbCgnbWFrZWNlcnQuZXhlJykpIH0sXG4gIH07XG5cbiAgaWYgKCFpc1ZhbGlkUHVibGlzaGVyTmFtZShwdWJsaXNoZXJOYW1lKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgUmVjZWl2ZWQgaW52YWxpZCBwdWJsaXNoZXIgbmFtZTogJyR7cHVibGlzaGVyTmFtZX0nIGRpZCBub3QgY29uZm9ybSB0byBYLjUwMCBkaXN0aW5ndWlzaGVkIG5hbWUgc3ludGF4IGZvciBNYWtlQ2VydC5gKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCBtYWtlQ2VydChtYWtlQ2VydE9wdGlvbnMpO1xufVxuXG5mdW5jdGlvbiBnZXREaXN0aW5ndWlzaGVkTmFtZUZyb21BdXRob3IoYXV0aG9yKSB7XG4gIHJldHVybiBgQ049JHtnZXROYW1lRnJvbUF1dGhvcihhdXRob3IpfWA7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7IGRpciwgYXBwTmFtZSwgdGFyZ2V0QXJjaCwgZm9yZ2VDb25maWcsIHBhY2thZ2VKU09OIH0pID0+IHtcbiAgY29uc3Qgb3V0UGF0aCA9IHBhdGgucmVzb2x2ZShkaXIsIGAuLi9tYWtlL2FwcHgvJHt0YXJnZXRBcmNofWApO1xuICBhd2FpdCBlbnN1cmVEaXJlY3Rvcnkob3V0UGF0aCk7XG5cbiAgY29uc3QgdXNlckNvbmZpZyA9IGNvbmZpZ0ZuKGZvcmdlQ29uZmlnLndpbmRvd3NTdG9yZUNvbmZpZywgdGFyZ2V0QXJjaCk7XG5cbiAgY29uc3Qgb3B0cyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIHB1Ymxpc2hlcjogZ2V0RGlzdGluZ3Vpc2hlZE5hbWVGcm9tQXV0aG9yKHBhY2thZ2VKU09OLmF1dGhvciksXG4gICAgZmxhdHRlbjogZmFsc2UsXG4gICAgZGVwbG95OiBmYWxzZSxcbiAgICBwYWNrYWdlVmVyc2lvbjogYCR7cGFja2FnZUpTT04udmVyc2lvbn0uMGAsXG4gICAgcGFja2FnZU5hbWU6IGFwcE5hbWUucmVwbGFjZSgvLS9nLCAnJyksXG4gICAgcGFja2FnZURpc3BsYXlOYW1lOiBhcHBOYW1lLFxuICAgIHBhY2thZ2VEZXNjcmlwdGlvbjogcGFja2FnZUpTT04uZGVzY3JpcHRpb24gfHwgYXBwTmFtZSxcbiAgICBwYWNrYWdlRXhlY3V0YWJsZTogYGFwcFxcXFwke2FwcE5hbWV9LmV4ZWAsXG4gICAgd2luZG93c0tpdDogdXNlckNvbmZpZy53aW5kb3dzS2l0IHx8IHBhdGguZGlybmFtZShmaW5kU2RrVG9vbCgnbWFrZWFwcHguZXhlJykpLFxuICB9LCB1c2VyQ29uZmlnLCB7XG4gICAgaW5wdXREaXJlY3Rvcnk6IGRpcixcbiAgICBvdXRwdXREaXJlY3Rvcnk6IG91dFBhdGgsXG4gIH0pO1xuXG4gIGlmICghb3B0cy5wdWJsaXNoZXIpIHtcbiAgICB0aHJvdyAnUGxlYXNlIHNldCBjb25maWcuZm9yZ2Uud2luZG93c1N0b3JlQ29uZmlnLnB1Ymxpc2hlciBvciBhdXRob3IubmFtZSBpbiBwYWNrYWdlLmpzb24gZm9yIHRoZSBhcHB4IHRhcmdldCc7XG4gIH1cblxuICBpZiAoIW9wdHMuZGV2Q2VydCkge1xuICAgIG9wdHMuZGV2Q2VydCA9IGF3YWl0IGNyZWF0ZURlZmF1bHRDZXJ0aWZpY2F0ZShvcHRzLnB1Ymxpc2hlciwgeyBjZXJ0RmlsZVBhdGg6IG91dFBhdGgsIHByb2dyYW06IG9wdHMgfSk7XG4gIH1cblxuICBpZiAob3B0cy5wYWNrYWdlVmVyc2lvbi5tYXRjaCgvLS8pKSB7XG4gICAgaWYgKG9wdHMubWFrZVZlcnNpb25XaW5TdG9yZUNvbXBhdGlibGUpIHtcbiAgICAgIGNvbnN0IG5vQmV0YSA9IG9wdHMucGFja2FnZVZlcnNpb24ucmVwbGFjZSgvLS4qLywgJycpO1xuICAgICAgb3B0cy5wYWNrYWdlVmVyc2lvbiA9IGAke25vQmV0YX0uMGA7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVyciA9IFwiV2luZG93cyBTdG9yZSB2ZXJzaW9uIG51bWJlcnMgZG9uJ3Qgc3VwcG9ydCBzZW12ZXIgYmV0YSB0YWdzLiBUb1wiICtcbiAgICAgICAgJ2F1dG9tYXRpY2FsbHkgZml4IHRoaXMsIHNldCBtYWtlVmVyc2lvbldpblN0b3JlQ29tcGF0aWJsZSB0byB0cnVlIG9yICcgK1xuICAgICAgICAnZXhwbGljaXRseSBzZXQgcGFja2FnZVZlcnNpb24gdG8gYSB2ZXJzaW9uIG9mIHRoZSBmb3JtYXQgWC5ZLlouQSc7XG5cbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGRlbGV0ZSBvcHRzLm1ha2VWZXJzaW9uV2luU3RvcmVDb21wYXRpYmxlO1xuXG4gIGF3YWl0IHdpbmRvd3NTdG9yZShvcHRzKTtcblxuICByZXR1cm4gW3BhdGgucmVzb2x2ZShvdXRQYXRoLCBgJHtvcHRzLnBhY2thZ2VOYW1lfS5hcHB4YCldO1xufTtcbiJdfQ==