'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.airbnbDeps = exports.standardDeps = exports.exactDevDeps = exports.devDeps = exports.deps = undefined;

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _bluebird = require('bluebird');

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _username = require('username');

var _username2 = _interopRequireDefault(_username);

var _forgeConfig = require('../util/forge-config');

var _installDependencies = require('../util/install-dependencies');

var _installDependencies2 = _interopRequireDefault(_installDependencies);

var _readPackageJson = require('../util/read-package-json');

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

var _oraHandler = require('../util/ora-handler');

var _oraHandler2 = _interopRequireDefault(_oraHandler);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug2.default)('electron-forge:init:npm');

const deps = exports.deps = ['electron-compile', 'electron-squirrel-startup'];
const devDeps = exports.devDeps = ['babel-preset-env', 'babel-preset-react', 'babel-plugin-transform-async-to-generator', 'electron-forge'];
const exactDevDeps = exports.exactDevDeps = ['electron-prebuilt-compile'];
const standardDeps = exports.standardDeps = ['standard'];
const airbnbDeps = exports.airbnbDeps = ['eslint@^3', 'eslint-config-airbnb@^15', 'eslint-plugin-import@^2', 'eslint-plugin-jsx-a11y@^5', 'eslint-plugin-react@^7'];

exports.default = (() => {
  var _ref = (0, _bluebird.coroutine)(function* (dir, lintStyle) {
    yield (0, _oraHandler2.default)('Initializing NPM Module', (0, _bluebird.coroutine)(function* () {
      const packageJSON = yield (0, _readPackageJson2.default)(_path2.default.resolve(__dirname, '../../tmpl'));
      packageJSON.productName = packageJSON.name = _path2.default.basename(dir).toLowerCase();
      packageJSON.author = yield (0, _username2.default)();
      (0, _forgeConfig.setInitialForgeConfig)(packageJSON);

      switch (lintStyle) {
        case 'standard':
          packageJSON.scripts.lint = 'standard';
          break;
        case 'airbnb':
          packageJSON.scripts.lint = 'eslint src --color';
          break;
        default:
          packageJSON.scripts.lint = 'echo "No linting configured"';
          break;
      }
      d('writing package.json to:', dir);
      yield _fsExtra2.default.writeJson(_path2.default.resolve(dir, 'package.json'), packageJSON, { spaces: 2 });
    }));

    yield (0, _oraHandler2.default)('Installing NPM Dependencies', (0, _bluebird.coroutine)(function* () {
      d('installing dependencies');
      yield (0, _installDependencies2.default)(dir, deps);

      d('installing devDependencies');
      yield (0, _installDependencies2.default)(dir, devDeps, true);

      d('installing exact dependencies');
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = (0, _getIterator3.default)(exactDevDeps), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const packageName = _step.value;

          yield (0, _installDependencies2.default)(dir, [packageName], true, true);
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      switch (lintStyle) {
        case 'standard':
          d('installing standard linting dependencies');
          yield (0, _installDependencies2.default)(dir, standardDeps, true);
          break;
        case 'airbnb':
          d('installing airbnb linting dependencies');
          yield (0, _installDependencies2.default)(dir, airbnbDeps, true);
          break;
        default:
          d('not installing linting deps');
          break;
      }

      // NB: For babel-preset-env to work correctly, it needs to know the
      // actual version of Electron that we installed
      const content = yield _fsExtra2.default.readJson(_path2.default.join(dir, '.compilerc'), 'utf8');
      const electronPrebuilt = require(_path2.default.join(dir, 'node_modules', 'electron-prebuilt-compile', 'package.json'));

      var _arr = ['development', 'production'];
      for (var _i = 0; _i < _arr.length; _i++) {
        const profile = _arr[_i];
        const envTarget = content.env[profile]['application/javascript'].presets.find(function (x) {
          return x[0] === 'env';
        });
        // parseFloat strips the patch version
        // parseFloat('1.3.2') === 1.3
        envTarget[1].targets.electron = parseFloat(electronPrebuilt.version).toString();
      }

      yield _fsExtra2.default.writeJson(_path2.default.join(dir, '.compilerc'), content, { spaces: 2 });
    }));
  });

  return function (_x, _x2) {
    return _ref.apply(this, arguments);
  };
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluaXQvaW5pdC1ucG0uanMiXSwibmFtZXMiOlsiZCIsImRlcHMiLCJkZXZEZXBzIiwiZXhhY3REZXZEZXBzIiwic3RhbmRhcmREZXBzIiwiYWlyYm5iRGVwcyIsImRpciIsImxpbnRTdHlsZSIsInBhY2thZ2VKU09OIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsInByb2R1Y3ROYW1lIiwibmFtZSIsImJhc2VuYW1lIiwidG9Mb3dlckNhc2UiLCJhdXRob3IiLCJzY3JpcHRzIiwibGludCIsIndyaXRlSnNvbiIsInNwYWNlcyIsInBhY2thZ2VOYW1lIiwiY29udGVudCIsInJlYWRKc29uIiwiam9pbiIsImVsZWN0cm9uUHJlYnVpbHQiLCJyZXF1aXJlIiwicHJvZmlsZSIsImVudlRhcmdldCIsImVudiIsInByZXNldHMiLCJmaW5kIiwieCIsInRhcmdldHMiLCJlbGVjdHJvbiIsInBhcnNlRmxvYXQiLCJ2ZXJzaW9uIiwidG9TdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsSUFBSSxxQkFBTSx5QkFBTixDQUFWOztBQUVPLE1BQU1DLHNCQUFPLENBQUMsa0JBQUQsRUFBcUIsMkJBQXJCLENBQWI7QUFDQSxNQUFNQyw0QkFBVSxDQUFDLGtCQUFELEVBQXFCLG9CQUFyQixFQUEyQywyQ0FBM0MsRUFBd0YsZ0JBQXhGLENBQWhCO0FBQ0EsTUFBTUMsc0NBQWUsQ0FBQywyQkFBRCxDQUFyQjtBQUNBLE1BQU1DLHNDQUFlLENBQUMsVUFBRCxDQUFyQjtBQUNBLE1BQU1DLGtDQUFhLENBQUMsV0FBRCxFQUFjLDBCQUFkLEVBQTBDLHlCQUExQyxFQUN4QiwyQkFEd0IsRUFDSyx3QkFETCxDQUFuQjs7O3NDQUdRLFdBQU9DLEdBQVAsRUFBWUMsU0FBWixFQUEwQjtBQUN2QyxVQUFNLDBCQUFTLHlCQUFULDJCQUFvQyxhQUFZ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T0FBM0MsRUFBb0QsRUFBRUYsUUFBUSxDQUFWLEVBQXBELENBQU47QUFDRCxLQXhDSyxFQUFOO0FBeUNELEciLCJmaWxlIjoiaW5pdC9pbml0LW5wbS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdXNlcm5hbWUgZnJvbSAndXNlcm5hbWUnO1xuXG5pbXBvcnQgeyBzZXRJbml0aWFsRm9yZ2VDb25maWcgfSBmcm9tICcuLi91dGlsL2ZvcmdlLWNvbmZpZyc7XG5pbXBvcnQgaW5zdGFsbERlcExpc3QgZnJvbSAnLi4vdXRpbC9pbnN0YWxsLWRlcGVuZGVuY2llcyc7XG5pbXBvcnQgcmVhZFBhY2thZ2VKU09OIGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IGFzeW5jT3JhIGZyb20gJy4uL3V0aWwvb3JhLWhhbmRsZXInO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOmluaXQ6bnBtJyk7XG5cbmV4cG9ydCBjb25zdCBkZXBzID0gWydlbGVjdHJvbi1jb21waWxlJywgJ2VsZWN0cm9uLXNxdWlycmVsLXN0YXJ0dXAnXTtcbmV4cG9ydCBjb25zdCBkZXZEZXBzID0gWydiYWJlbC1wcmVzZXQtZW52JywgJ2JhYmVsLXByZXNldC1yZWFjdCcsICdiYWJlbC1wbHVnaW4tdHJhbnNmb3JtLWFzeW5jLXRvLWdlbmVyYXRvcicsICdlbGVjdHJvbi1mb3JnZSddO1xuZXhwb3J0IGNvbnN0IGV4YWN0RGV2RGVwcyA9IFsnZWxlY3Ryb24tcHJlYnVpbHQtY29tcGlsZSddO1xuZXhwb3J0IGNvbnN0IHN0YW5kYXJkRGVwcyA9IFsnc3RhbmRhcmQnXTtcbmV4cG9ydCBjb25zdCBhaXJibmJEZXBzID0gWydlc2xpbnRAXjMnLCAnZXNsaW50LWNvbmZpZy1haXJibmJAXjE1JywgJ2VzbGludC1wbHVnaW4taW1wb3J0QF4yJyxcbiAgJ2VzbGludC1wbHVnaW4tanN4LWExMXlAXjUnLCAnZXNsaW50LXBsdWdpbi1yZWFjdEBeNyddO1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAoZGlyLCBsaW50U3R5bGUpID0+IHtcbiAgYXdhaXQgYXN5bmNPcmEoJ0luaXRpYWxpemluZyBOUE0gTW9kdWxlJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHBhY2thZ2VKU09OID0gYXdhaXQgcmVhZFBhY2thZ2VKU09OKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi90bXBsJykpO1xuICAgIHBhY2thZ2VKU09OLnByb2R1Y3ROYW1lID0gcGFja2FnZUpTT04ubmFtZSA9IHBhdGguYmFzZW5hbWUoZGlyKS50b0xvd2VyQ2FzZSgpO1xuICAgIHBhY2thZ2VKU09OLmF1dGhvciA9IGF3YWl0IHVzZXJuYW1lKCk7XG4gICAgc2V0SW5pdGlhbEZvcmdlQ29uZmlnKHBhY2thZ2VKU09OKTtcblxuICAgIHN3aXRjaCAobGludFN0eWxlKSB7XG4gICAgICBjYXNlICdzdGFuZGFyZCc6XG4gICAgICAgIHBhY2thZ2VKU09OLnNjcmlwdHMubGludCA9ICdzdGFuZGFyZCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnYWlyYm5iJzpcbiAgICAgICAgcGFja2FnZUpTT04uc2NyaXB0cy5saW50ID0gJ2VzbGludCBzcmMgLS1jb2xvcic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcGFja2FnZUpTT04uc2NyaXB0cy5saW50ID0gJ2VjaG8gXCJObyBsaW50aW5nIGNvbmZpZ3VyZWRcIic7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBkKCd3cml0aW5nIHBhY2thZ2UuanNvbiB0bzonLCBkaXIpO1xuICAgIGF3YWl0IGZzLndyaXRlSnNvbihwYXRoLnJlc29sdmUoZGlyLCAncGFja2FnZS5qc29uJyksIHBhY2thZ2VKU09OLCB7IHNwYWNlczogMiB9KTtcbiAgfSk7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0luc3RhbGxpbmcgTlBNIERlcGVuZGVuY2llcycsIGFzeW5jICgpID0+IHtcbiAgICBkKCdpbnN0YWxsaW5nIGRlcGVuZGVuY2llcycpO1xuICAgIGF3YWl0IGluc3RhbGxEZXBMaXN0KGRpciwgZGVwcyk7XG5cbiAgICBkKCdpbnN0YWxsaW5nIGRldkRlcGVuZGVuY2llcycpO1xuICAgIGF3YWl0IGluc3RhbGxEZXBMaXN0KGRpciwgZGV2RGVwcywgdHJ1ZSk7XG5cbiAgICBkKCdpbnN0YWxsaW5nIGV4YWN0IGRlcGVuZGVuY2llcycpO1xuICAgIGZvciAoY29uc3QgcGFja2FnZU5hbWUgb2YgZXhhY3REZXZEZXBzKSB7XG4gICAgICBhd2FpdCBpbnN0YWxsRGVwTGlzdChkaXIsIFtwYWNrYWdlTmFtZV0sIHRydWUsIHRydWUpO1xuICAgIH1cblxuICAgIHN3aXRjaCAobGludFN0eWxlKSB7XG4gICAgICBjYXNlICdzdGFuZGFyZCc6XG4gICAgICAgIGQoJ2luc3RhbGxpbmcgc3RhbmRhcmQgbGludGluZyBkZXBlbmRlbmNpZXMnKTtcbiAgICAgICAgYXdhaXQgaW5zdGFsbERlcExpc3QoZGlyLCBzdGFuZGFyZERlcHMsIHRydWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2FpcmJuYic6XG4gICAgICAgIGQoJ2luc3RhbGxpbmcgYWlyYm5iIGxpbnRpbmcgZGVwZW5kZW5jaWVzJyk7XG4gICAgICAgIGF3YWl0IGluc3RhbGxEZXBMaXN0KGRpciwgYWlyYm5iRGVwcywgdHJ1ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgZCgnbm90IGluc3RhbGxpbmcgbGludGluZyBkZXBzJyk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIC8vIE5COiBGb3IgYmFiZWwtcHJlc2V0LWVudiB0byB3b3JrIGNvcnJlY3RseSwgaXQgbmVlZHMgdG8ga25vdyB0aGVcbiAgICAvLyBhY3R1YWwgdmVyc2lvbiBvZiBFbGVjdHJvbiB0aGF0IHdlIGluc3RhbGxlZFxuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBmcy5yZWFkSnNvbihwYXRoLmpvaW4oZGlyLCAnLmNvbXBpbGVyYycpLCAndXRmOCcpO1xuICAgIGNvbnN0IGVsZWN0cm9uUHJlYnVpbHQgPSByZXF1aXJlKFxuICAgICAgcGF0aC5qb2luKGRpciwgJ25vZGVfbW9kdWxlcycsICdlbGVjdHJvbi1wcmVidWlsdC1jb21waWxlJywgJ3BhY2thZ2UuanNvbicpKTtcblxuICAgIGZvciAoY29uc3QgcHJvZmlsZSBvZiBbJ2RldmVsb3BtZW50JywgJ3Byb2R1Y3Rpb24nXSkge1xuICAgICAgY29uc3QgZW52VGFyZ2V0ID0gY29udGVudC5lbnZbcHJvZmlsZV1bJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnXS5wcmVzZXRzLmZpbmQoeCA9PiB4WzBdID09PSAnZW52Jyk7XG4gICAgICAvLyBwYXJzZUZsb2F0IHN0cmlwcyB0aGUgcGF0Y2ggdmVyc2lvblxuICAgICAgLy8gcGFyc2VGbG9hdCgnMS4zLjInKSA9PT0gMS4zXG4gICAgICBlbnZUYXJnZXRbMV0udGFyZ2V0cy5lbGVjdHJvbiA9IHBhcnNlRmxvYXQoZWxlY3Ryb25QcmVidWlsdC52ZXJzaW9uKS50b1N0cmluZygpO1xuICAgIH1cblxuICAgIGF3YWl0IGZzLndyaXRlSnNvbihwYXRoLmpvaW4oZGlyLCAnLmNvbXBpbGVyYycpLCBjb250ZW50LCB7IHNwYWNlczogMiB9KTtcbiAgfSk7XG59O1xuIl19