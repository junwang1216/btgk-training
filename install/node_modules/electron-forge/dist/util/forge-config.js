'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _bluebird = require('bluebird');

var _getOwnPropertyDescriptor = require('babel-runtime/core-js/object/get-own-property-descriptor');

var _getOwnPropertyDescriptor2 = _interopRequireDefault(_getOwnPropertyDescriptor);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

exports.setInitialForgeConfig = setInitialForgeConfig;

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash.template');

var _lodash2 = _interopRequireDefault(_lodash);

var _readPackageJson = require('./read-package-json');

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

var _yarnOrNpm = require('./yarn-or-npm');

var _yarnOrNpm2 = _interopRequireDefault(_yarnOrNpm);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const underscoreCase = str => str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase();

const proxify = (object, envPrefix) => {
  const newObject = {};

  (0, _keys2.default)(object).forEach(key => {
    if (typeof object[key] === 'object' && !Array.isArray(object[key])) {
      newObject[key] = proxify(object[key], `${envPrefix}_${underscoreCase(key)}`);
    } else {
      newObject[key] = object[key];
    }
  });

  return new Proxy(newObject, {
    get(target, name) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
        if (envValue) return envValue;
      }
      return target[name];
    },
    getOwnPropertyDescriptor(target, name) {
      const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
      // eslint-disable-next-line no-prototype-builtins
      if (target.hasOwnProperty(name)) {
        return (0, _getOwnPropertyDescriptor2.default)(target, name);
      } else if (envValue) {
        return { writable: true, enumerable: true, configurable: true, value: envValue };
      }
    }
  });
};

/**
 * Sets sensible defaults for the `config.forge` object.
 */
function setInitialForgeConfig(packageJSON) {
  var _packageJSON$name = packageJSON.name;
  const name = _packageJSON$name === undefined ? '' : _packageJSON$name;
  var _packageJSON$productN = packageJSON.productName;
  const productName = _packageJSON$productN === undefined ? name : _packageJSON$productN;

  /* eslint-disable no-param-reassign */

  packageJSON.config.forge.electronWinstallerConfig.name = name.replace(/-/g, '_');
  packageJSON.config.forge.windowsStoreConfig.name = productName.replace(/-/g, '');
  packageJSON.config.forge.electronPackagerConfig.packageManager = (0, _yarnOrNpm2.default)();
  /* eslint-enable no-param-reassign */
}

exports.default = (() => {
  var _ref = (0, _bluebird.coroutine)(function* (dir) {
    const packageJSON = yield (0, _readPackageJson2.default)(dir);
    let forgeConfig = packageJSON.config.forge;
    if (typeof forgeConfig === 'string' && ((yield _fsExtra2.default.pathExists(_path2.default.resolve(dir, forgeConfig))) || (yield _fsExtra2.default.pathExists(_path2.default.resolve(dir, `${forgeConfig}.js`))))) {
      try {
        forgeConfig = require(_path2.default.resolve(dir, forgeConfig));
      } catch (err) {
        console.error(`Failed to load: ${_path2.default.resolve(dir, forgeConfig)}`);
        throw err;
      }
    } else if (typeof forgeConfig !== 'object') {
      throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');
    }
    forgeConfig = (0, _assign2.default)({
      make_targets: {},
      publish_targets: {},
      electronPackagerConfig: {},
      electronRebuildConfig: {},
      electronWinstallerConfig: {},
      electronInstallerDebian: {},
      electronInstallerDMG: {},
      electronInstallerRedhat: {},
      s3: {},
      github_repository: {},
      electronReleaseServer: {}
    }, forgeConfig);
    forgeConfig.make_targets = (0, _assign2.default)({
      win32: ['squirrel'],
      darwin: ['zip'],
      mas: ['zip'],
      linux: ['deb', 'rpm']
    }, forgeConfig.make_targets);
    forgeConfig.publish_targets = (0, _assign2.default)({
      win32: ['github'],
      darwin: ['github'],
      mas: ['github'],
      linux: ['github']
    }, forgeConfig.publish_targets);

    const templateObj = (0, _assign2.default)({}, packageJSON, { year: new Date().getFullYear() });
    const template = function template(obj) {
      (0, _keys2.default)(obj).forEach(function (objKey) {
        if (typeof obj[objKey] === 'object' && obj !== null) {
          template(obj[objKey]);
        } else if (typeof obj[objKey] === 'string') {
          obj[objKey] = (0, _lodash2.default)(obj[objKey])(templateObj); // eslint-disable-line
          if (obj[objKey].startsWith('require:')) {
            obj[objKey] = require(_path2.default.resolve(dir, obj[objKey].substr(8))); // eslint-disable-line
          }
        }
      });
    };

    template(forgeConfig);

    return proxify(forgeConfig, 'ELECTRON_FORGE');
  });

  return function (_x) {
    return _ref.apply(this, arguments);
  };
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWwvZm9yZ2UtY29uZmlnLmpzIl0sIm5hbWVzIjpbInNldEluaXRpYWxGb3JnZUNvbmZpZyIsInVuZGVyc2NvcmVDYXNlIiwic3RyIiwicmVwbGFjZSIsInRvVXBwZXJDYXNlIiwicHJveGlmeSIsIm9iamVjdCIsImVudlByZWZpeCIsIm5ld09iamVjdCIsImZvckVhY2giLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJQcm94eSIsImdldCIsInRhcmdldCIsIm5hbWUiLCJoYXNPd25Qcm9wZXJ0eSIsImVudlZhbHVlIiwicHJvY2VzcyIsImVudiIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsIndyaXRhYmxlIiwiZW51bWVyYWJsZSIsImNvbmZpZ3VyYWJsZSIsInZhbHVlIiwicGFja2FnZUpTT04iLCJwcm9kdWN0TmFtZSIsImNvbmZpZyIsImZvcmdlIiwiZWxlY3Ryb25XaW5zdGFsbGVyQ29uZmlnIiwid2luZG93c1N0b3JlQ29uZmlnIiwiZWxlY3Ryb25QYWNrYWdlckNvbmZpZyIsInBhY2thZ2VNYW5hZ2VyIiwiZGlyIiwiZm9yZ2VDb25maWciLCJwYXRoRXhpc3RzIiwicmVzb2x2ZSIsInJlcXVpcmUiLCJlcnIiLCJjb25zb2xlIiwiZXJyb3IiLCJFcnJvciIsIm1ha2VfdGFyZ2V0cyIsInB1Ymxpc2hfdGFyZ2V0cyIsImVsZWN0cm9uUmVidWlsZENvbmZpZyIsImVsZWN0cm9uSW5zdGFsbGVyRGViaWFuIiwiZWxlY3Ryb25JbnN0YWxsZXJETUciLCJlbGVjdHJvbkluc3RhbGxlclJlZGhhdCIsInMzIiwiZ2l0aHViX3JlcG9zaXRvcnkiLCJlbGVjdHJvblJlbGVhc2VTZXJ2ZXIiLCJ3aW4zMiIsImRhcndpbiIsIm1hcyIsImxpbnV4IiwidGVtcGxhdGVPYmoiLCJ5ZWFyIiwiRGF0ZSIsImdldEZ1bGxZZWFyIiwidGVtcGxhdGUiLCJvYmoiLCJvYmpLZXkiLCJzdGFydHNXaXRoIiwic3Vic3RyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7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YUFBU3pCLFdBQVQ7O0FBRUEsV0FBTzlCLFFBQVE4QixXQUFSLEVBQXFCLGdCQUFyQixDQUFQO0FBQ0QsRyIsImZpbGUiOiJ1dGlsL2ZvcmdlLWNvbmZpZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfdGVtcGxhdGUgZnJvbSAnbG9kYXNoLnRlbXBsYXRlJztcbmltcG9ydCByZWFkUGFja2FnZUpTT04gZnJvbSAnLi9yZWFkLXBhY2thZ2UtanNvbic7XG5pbXBvcnQgeWFybk9yTnBtIGZyb20gJy4veWFybi1vci1ucG0nO1xuXG5jb25zdCB1bmRlcnNjb3JlQ2FzZSA9IHN0ciA9PiBzdHIucmVwbGFjZSgvKC4pKFtBLVpdW2Etel0rKS9nLCAnJDFfJDInKS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDFfJDInKS50b1VwcGVyQ2FzZSgpO1xuXG5jb25zdCBwcm94aWZ5ID0gKG9iamVjdCwgZW52UHJlZml4KSA9PiB7XG4gIGNvbnN0IG5ld09iamVjdCA9IHt9O1xuXG4gIE9iamVjdC5rZXlzKG9iamVjdCkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgaWYgKHR5cGVvZiBvYmplY3Rba2V5XSA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkob2JqZWN0W2tleV0pKSB7XG4gICAgICBuZXdPYmplY3Rba2V5XSA9IHByb3hpZnkob2JqZWN0W2tleV0sIGAke2VudlByZWZpeH1fJHt1bmRlcnNjb3JlQ2FzZShrZXkpfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBuZXdPYmplY3Rba2V5XSA9IG9iamVjdFtrZXldO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIG5ldyBQcm94eShuZXdPYmplY3QsIHtcbiAgICBnZXQodGFyZ2V0LCBuYW1lKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcHJvdG90eXBlLWJ1aWx0aW5zXG4gICAgICBpZiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgZW52VmFsdWUgPSBwcm9jZXNzLmVudltgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2UobmFtZSl9YF07XG4gICAgICAgIGlmIChlbnZWYWx1ZSkgcmV0dXJuIGVudlZhbHVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRhcmdldFtuYW1lXTtcbiAgICB9LFxuICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpIHtcbiAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKG5hbWUpfWBdO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgaWYgKHRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpO1xuICAgICAgfSBlbHNlIGlmIChlbnZWYWx1ZSkge1xuICAgICAgICByZXR1cm4geyB3cml0YWJsZTogdHJ1ZSwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB2YWx1ZTogZW52VmFsdWUgfTtcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcbn07XG5cbi8qKlxuICogU2V0cyBzZW5zaWJsZSBkZWZhdWx0cyBmb3IgdGhlIGBjb25maWcuZm9yZ2VgIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldEluaXRpYWxGb3JnZUNvbmZpZyhwYWNrYWdlSlNPTikge1xuICBjb25zdCB7IG5hbWUgPSAnJywgcHJvZHVjdE5hbWUgPSBuYW1lIH0gPSBwYWNrYWdlSlNPTjtcblxuICAvKiBlc2xpbnQtZGlzYWJsZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UuZWxlY3Ryb25XaW5zdGFsbGVyQ29uZmlnLm5hbWUgPSBuYW1lLnJlcGxhY2UoLy0vZywgJ18nKTtcbiAgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlLndpbmRvd3NTdG9yZUNvbmZpZy5uYW1lID0gcHJvZHVjdE5hbWUucmVwbGFjZSgvLS9nLCAnJyk7XG4gIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZS5lbGVjdHJvblBhY2thZ2VyQ29uZmlnLnBhY2thZ2VNYW5hZ2VyID0geWFybk9yTnBtKCk7XG4gIC8qIGVzbGludC1lbmFibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKGRpcikgPT4ge1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRQYWNrYWdlSlNPTihkaXIpO1xuICBsZXQgZm9yZ2VDb25maWcgPSBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2U7XG4gIGlmICh0eXBlb2YgZm9yZ2VDb25maWcgPT09ICdzdHJpbmcnICYmIChhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsIGZvcmdlQ29uZmlnKSkgfHwgYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCBgJHtmb3JnZUNvbmZpZ30uanNgKSkpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGZvcmdlQ29uZmlnID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZykpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGxvYWQ6ICR7cGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcpfWApO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgZm9yZ2VDb25maWcgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgdG8gYmUgYW4gb2JqZWN0IG9yIHBvaW50IHRvIGEgcmVxdWlyYWJsZSBKUyBmaWxlJyk7XG4gIH1cbiAgZm9yZ2VDb25maWcgPSBPYmplY3QuYXNzaWduKHtcbiAgICBtYWtlX3RhcmdldHM6IHt9LFxuICAgIHB1Ymxpc2hfdGFyZ2V0czoge30sXG4gICAgZWxlY3Ryb25QYWNrYWdlckNvbmZpZzoge30sXG4gICAgZWxlY3Ryb25SZWJ1aWxkQ29uZmlnOiB7fSxcbiAgICBlbGVjdHJvbldpbnN0YWxsZXJDb25maWc6IHt9LFxuICAgIGVsZWN0cm9uSW5zdGFsbGVyRGViaWFuOiB7fSxcbiAgICBlbGVjdHJvbkluc3RhbGxlckRNRzoge30sXG4gICAgZWxlY3Ryb25JbnN0YWxsZXJSZWRoYXQ6IHt9LFxuICAgIHMzOiB7fSxcbiAgICBnaXRodWJfcmVwb3NpdG9yeToge30sXG4gICAgZWxlY3Ryb25SZWxlYXNlU2VydmVyOiB7fSxcbiAgfSwgZm9yZ2VDb25maWcpO1xuICBmb3JnZUNvbmZpZy5tYWtlX3RhcmdldHMgPSBPYmplY3QuYXNzaWduKHtcbiAgICB3aW4zMjogWydzcXVpcnJlbCddLFxuICAgIGRhcndpbjogWyd6aXAnXSxcbiAgICBtYXM6IFsnemlwJ10sXG4gICAgbGludXg6IFsnZGViJywgJ3JwbSddLFxuICB9LCBmb3JnZUNvbmZpZy5tYWtlX3RhcmdldHMpO1xuICBmb3JnZUNvbmZpZy5wdWJsaXNoX3RhcmdldHMgPSBPYmplY3QuYXNzaWduKHtcbiAgICB3aW4zMjogWydnaXRodWInXSxcbiAgICBkYXJ3aW46IFsnZ2l0aHViJ10sXG4gICAgbWFzOiBbJ2dpdGh1YiddLFxuICAgIGxpbnV4OiBbJ2dpdGh1YiddLFxuICB9LCBmb3JnZUNvbmZpZy5wdWJsaXNoX3RhcmdldHMpO1xuXG4gIGNvbnN0IHRlbXBsYXRlT2JqID0gT2JqZWN0LmFzc2lnbih7fSwgcGFja2FnZUpTT04sIHsgeWVhcjogKG5ldyBEYXRlKCkpLmdldEZ1bGxZZWFyKCkgfSk7XG4gIGNvbnN0IHRlbXBsYXRlID0gKG9iaikgPT4ge1xuICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaCgob2JqS2V5KSA9PiB7XG4gICAgICBpZiAodHlwZW9mIG9ialtvYmpLZXldID09PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHtcbiAgICAgICAgdGVtcGxhdGUob2JqW29iaktleV0pO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqW29iaktleV0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG9ialtvYmpLZXldID0gX3RlbXBsYXRlKG9ialtvYmpLZXldKSh0ZW1wbGF0ZU9iaik7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICAgICAgaWYgKG9ialtvYmpLZXldLnN0YXJ0c1dpdGgoJ3JlcXVpcmU6JykpIHtcbiAgICAgICAgICBvYmpbb2JqS2V5XSA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKGRpciwgb2JqW29iaktleV0uc3Vic3RyKDgpKSk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9O1xuXG4gIHRlbXBsYXRlKGZvcmdlQ29uZmlnKTtcblxuICByZXR1cm4gcHJveGlmeShmb3JnZUNvbmZpZywgJ0VMRUNUUk9OX0ZPUkdFJyk7XG59O1xuIl19