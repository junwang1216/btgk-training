'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _bluebird = require('bluebird');

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _nodeFetch = require('node-fetch');

var _nodeFetch2 = _interopRequireDefault(_nodeFetch);

var _formData = require('form-data');

var _formData2 = _interopRequireDefault(_formData);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _oraHandler = require('../util/ora-handler');

var _oraHandler2 = _interopRequireDefault(_oraHandler);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug2.default)('electron-forge:publish:ers');

const ersPlatform = (platform, arch) => {
  switch (platform) {
    case 'darwin':
      return 'osx_64';
    case 'linux':
      return arch === 'ia32' ? 'linux_32' : 'linux_64';
    case 'win32':
      return arch === 'ia32' ? 'windows_32' : 'windows_64';
    default:
      return platform;
  }
};

exports.default = (() => {
  var _ref = (0, _bluebird.coroutine)(function* ({ artifacts, packageJSON, forgeConfig, platform, arch }) {
    const ersConfig = forgeConfig.electronReleaseServer;
    if (!(ersConfig.baseUrl && ersConfig.username && ersConfig.password)) {
      throw 'In order to publish to ERS you must set the "electronReleaseServer.baseUrl", "electronReleaseServer.username" and "electronReleaseServer.password" properties in your forge config. See the docs for more info'; // eslint-disable-line
    }

    d('attempting to authenticate to ERS');

    const api = function api(apiPath) {
      return `${ersConfig.baseUrl}/${apiPath}`;
    };

    var _ref2 = yield (yield (0, _nodeFetch2.default)(api('api/auth/login'), {
      method: 'POST',
      body: (0, _stringify2.default)({
        username: ersConfig.username,
        password: ersConfig.password
      }),
      headers: {
        'Content-Type': 'application/json'
      }
    })).json();

    const token = _ref2.token;


    const authFetch = function authFetch(apiPath, options) {
      return (0, _nodeFetch2.default)(api(apiPath), (0, _assign2.default)({}, options || {}, {
        headers: (0, _assign2.default)({}, (options || {}).headers, { Authorization: `Bearer ${token}` })
      }));
    };

    const versions = yield (yield authFetch('api/version')).json();
    const existingVersion = versions.find(function (version) {
      return version.name === packageJSON.version;
    });

    let channel = 'stable';
    if (packageJSON.version.indexOf('beta') !== -1) {
      channel = 'beta';
    }
    if (packageJSON.version.indexOf('alpha') !== -1) {
      channel = 'alpha';
    }

    if (!existingVersion) {
      yield authFetch('api/version', {
        method: 'POST',
        body: (0, _stringify2.default)({
          channel: {
            name: channel
          },
          name: packageJSON.version,
          notes: ''
        }),
        headers: {
          'Content-Type': 'application/json'
        }
      });
    }

    let uploaded = 0;
    yield (0, _oraHandler2.default)(`Uploading Artifacts ${uploaded}/${artifacts.length}`, (() => {
      var _ref3 = (0, _bluebird.coroutine)(function* (uploadSpinner) {
        const updateSpinner = function updateSpinner() {
          uploadSpinner.text = `Uploading Artifacts ${uploaded}/${artifacts.length}`; // eslint-disable-line no-param-reassign
        };

        yield _promise2.default.all(artifacts.map(function (artifactPath) {
          return new _promise2.default((() => {
            var _ref4 = (0, _bluebird.coroutine)(function* (resolve, reject) {
              if (existingVersion) {
                const existingAsset = existingVersion.assets.find(function (asset) {
                  return asset.name === _path2.default.basename(artifactPath);
                });
                if (existingAsset) {
                  d('asset at path:', artifactPath, 'already exists on server');
                  uploaded += 1;
                  updateSpinner();
                  return;
                }
              }
              try {
                d('attempting to upload asset:', artifactPath);
                const artifactForm = new _formData2.default();
                artifactForm.append('token', token);
                artifactForm.append('version', packageJSON.version);
                artifactForm.append('platform', ersPlatform(platform, arch));
                artifactForm.append('file', _fsExtra2.default.createReadStream(artifactPath));
                yield authFetch('api/asset', {
                  method: 'POST',
                  body: artifactForm,
                  headers: artifactForm.getHeaders()
                });
                d('upload successful for asset:', artifactPath);
                uploaded += 1;
                updateSpinner();
              } catch (err) {
                reject(err);
              }
            });

            return function (_x3, _x4) {
              return _ref4.apply(this, arguments);
            };
          })());
        }));
      });

      return function (_x2) {
        return _ref3.apply(this, arguments);
      };
    })());
  });

  return function (_x) {
    return _ref.apply(this, arguments);
  };
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB1Ymxpc2hlcnMvZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXIuanMiXSwibmFtZXMiOlsiZCIsImVyc1BsYXRmb3JtIiwicGxhdGZvcm0iLCJhcmNoIiwiYXJ0aWZhY3RzIiwicGFja2FnZUpTT04iLCJmb3JnZUNvbmZpZyIsImVyc0NvbmZpZyIsImVsZWN0cm9uUmVsZWFzZVNlcnZlciIsImJhc2VVcmwiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwiYXBpIiwiYXBpUGF0aCIsIm1ldGhvZCIsImJvZHkiLCJoZWFkZXJzIiwianNvbiIsInRva2VuIiwiYXV0aEZldGNoIiwib3B0aW9ucyIsIkF1dGhvcml6YXRpb24iLCJ2ZXJzaW9ucyIsImV4aXN0aW5nVmVyc2lvbiIsImZpbmQiLCJ2ZXJzaW9uIiwibmFtZSIsImNoYW5uZWwiLCJpbmRleE9mIiwibm90ZXMiLCJ1cGxvYWRlZCIsImxlbmd0aCIsInVwbG9hZFNwaW5uZXIiLCJ1cGRhdGVTcGlubmVyIiwidGV4dCIsImFsbCIsIm1hcCIsInJlc29sdmUiLCJyZWplY3QiLCJleGlzdGluZ0Fzc2V0IiwiYXNzZXRzIiwiYXNzZXQiLCJiYXNlbmFtZSIsImFydGlmYWN0UGF0aCIsImFydGlmYWN0Rm9ybSIsImFwcGVuZCIsImNyZWF0ZVJlYWRTdHJlYW0iLCJnZXRIZWFkZXJzIiwiZXJyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7Ozs7O0FBRUEsTUFBTUEsSUFBSSxxQkFBTSw0QkFBTixDQUFWOztBQUVBLE1BQU1DLGNBQWMsQ0FBQ0MsUUFBRCxFQUFXQyxJQUFYLEtBQW9CO0FBQ3RDLFVBQVFELFFBQVI7QUFDRSxTQUFLLFFBQUw7QUFDRSxhQUFPLFFBQVA7QUFDRixTQUFLLE9BQUw7QUFDRSxhQUFPQyxTQUFTLE1BQVQsR0FBa0IsVUFBbEIsR0FBK0IsVUFBdEM7QUFDRixTQUFLLE9BQUw7QUFDRSxhQUFPQSxT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QStCRCxPQXBDSzs7QUFBQTtBQUFBO0FBQUE7QUFBQSxTQUFOO0FBcUNELEciLCJmaWxlIjoicHVibGlzaGVycy9lbGVjdHJvbi1yZWxlYXNlLXNlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XG5pbXBvcnQgRm9ybURhdGEgZnJvbSAnZm9ybS1kYXRhJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IGFzeW5jT3JhIGZyb20gJy4uL3V0aWwvb3JhLWhhbmRsZXInO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOnB1Ymxpc2g6ZXJzJyk7XG5cbmNvbnN0IGVyc1BsYXRmb3JtID0gKHBsYXRmb3JtLCBhcmNoKSA9PiB7XG4gIHN3aXRjaCAocGxhdGZvcm0pIHtcbiAgICBjYXNlICdkYXJ3aW4nOlxuICAgICAgcmV0dXJuICdvc3hfNjQnO1xuICAgIGNhc2UgJ2xpbnV4JzpcbiAgICAgIHJldHVybiBhcmNoID09PSAnaWEzMicgPyAnbGludXhfMzInIDogJ2xpbnV4XzY0JztcbiAgICBjYXNlICd3aW4zMic6XG4gICAgICByZXR1cm4gYXJjaCA9PT0gJ2lhMzInID8gJ3dpbmRvd3NfMzInIDogJ3dpbmRvd3NfNjQnO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gcGxhdGZvcm07XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7IGFydGlmYWN0cywgcGFja2FnZUpTT04sIGZvcmdlQ29uZmlnLCBwbGF0Zm9ybSwgYXJjaCB9KSA9PiB7XG4gIGNvbnN0IGVyc0NvbmZpZyA9IGZvcmdlQ29uZmlnLmVsZWN0cm9uUmVsZWFzZVNlcnZlcjtcbiAgaWYgKCEoZXJzQ29uZmlnLmJhc2VVcmwgJiYgZXJzQ29uZmlnLnVzZXJuYW1lICYmIGVyc0NvbmZpZy5wYXNzd29yZCkpIHtcbiAgICB0aHJvdyAnSW4gb3JkZXIgdG8gcHVibGlzaCB0byBFUlMgeW91IG11c3Qgc2V0IHRoZSBcImVsZWN0cm9uUmVsZWFzZVNlcnZlci5iYXNlVXJsXCIsIFwiZWxlY3Ryb25SZWxlYXNlU2VydmVyLnVzZXJuYW1lXCIgYW5kIFwiZWxlY3Ryb25SZWxlYXNlU2VydmVyLnBhc3N3b3JkXCIgcHJvcGVydGllcyBpbiB5b3VyIGZvcmdlIGNvbmZpZy4gU2VlIHRoZSBkb2NzIGZvciBtb3JlIGluZm8nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gIH1cblxuICBkKCdhdHRlbXB0aW5nIHRvIGF1dGhlbnRpY2F0ZSB0byBFUlMnKTtcblxuICBjb25zdCBhcGkgPSBhcGlQYXRoID0+IGAke2Vyc0NvbmZpZy5iYXNlVXJsfS8ke2FwaVBhdGh9YDtcblxuICBjb25zdCB7IHRva2VuIH0gPSBhd2FpdCAoYXdhaXQgZmV0Y2goYXBpKCdhcGkvYXV0aC9sb2dpbicpLCB7XG4gICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgdXNlcm5hbWU6IGVyc0NvbmZpZy51c2VybmFtZSxcbiAgICAgIHBhc3N3b3JkOiBlcnNDb25maWcucGFzc3dvcmQsXG4gICAgfSksXG4gICAgaGVhZGVyczoge1xuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICB9LFxuICB9KSkuanNvbigpO1xuXG4gIGNvbnN0IGF1dGhGZXRjaCA9IChhcGlQYXRoLCBvcHRpb25zKSA9PiBmZXRjaChhcGkoYXBpUGF0aCksIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgfHwge30sIHtcbiAgICBoZWFkZXJzOiBPYmplY3QuYXNzaWduKHt9LCAob3B0aW9ucyB8fCB7fSkuaGVhZGVycywgeyBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCB9KSxcbiAgfSkpO1xuXG4gIGNvbnN0IHZlcnNpb25zID0gYXdhaXQgKGF3YWl0IGF1dGhGZXRjaCgnYXBpL3ZlcnNpb24nKSkuanNvbigpO1xuICBjb25zdCBleGlzdGluZ1ZlcnNpb24gPSB2ZXJzaW9ucy5maW5kKHZlcnNpb24gPT4gdmVyc2lvbi5uYW1lID09PSBwYWNrYWdlSlNPTi52ZXJzaW9uKTtcblxuICBsZXQgY2hhbm5lbCA9ICdzdGFibGUnO1xuICBpZiAocGFja2FnZUpTT04udmVyc2lvbi5pbmRleE9mKCdiZXRhJykgIT09IC0xKSB7XG4gICAgY2hhbm5lbCA9ICdiZXRhJztcbiAgfVxuICBpZiAocGFja2FnZUpTT04udmVyc2lvbi5pbmRleE9mKCdhbHBoYScpICE9PSAtMSkge1xuICAgIGNoYW5uZWwgPSAnYWxwaGEnO1xuICB9XG5cbiAgaWYgKCFleGlzdGluZ1ZlcnNpb24pIHtcbiAgICBhd2FpdCBhdXRoRmV0Y2goJ2FwaS92ZXJzaW9uJywge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGNoYW5uZWw6IHtcbiAgICAgICAgICBuYW1lOiBjaGFubmVsLFxuICAgICAgICB9LFxuICAgICAgICBuYW1lOiBwYWNrYWdlSlNPTi52ZXJzaW9uLFxuICAgICAgICBub3RlczogJycsXG4gICAgICB9KSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBsZXQgdXBsb2FkZWQgPSAwO1xuICBhd2FpdCBhc3luY09yYShgVXBsb2FkaW5nIEFydGlmYWN0cyAke3VwbG9hZGVkfS8ke2FydGlmYWN0cy5sZW5ndGh9YCwgYXN5bmMgKHVwbG9hZFNwaW5uZXIpID0+IHtcbiAgICBjb25zdCB1cGRhdGVTcGlubmVyID0gKCkgPT4ge1xuICAgICAgdXBsb2FkU3Bpbm5lci50ZXh0ID0gYFVwbG9hZGluZyBBcnRpZmFjdHMgJHt1cGxvYWRlZH0vJHthcnRpZmFjdHMubGVuZ3RofWA7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tcGFyYW0tcmVhc3NpZ25cbiAgICB9O1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoYXJ0aWZhY3RzLm1hcChhcnRpZmFjdFBhdGggPT5cbiAgICAgIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgaWYgKGV4aXN0aW5nVmVyc2lvbikge1xuICAgICAgICAgIGNvbnN0IGV4aXN0aW5nQXNzZXQgPSBleGlzdGluZ1ZlcnNpb24uYXNzZXRzLmZpbmQoYXNzZXQgPT4gYXNzZXQubmFtZSA9PT0gcGF0aC5iYXNlbmFtZShhcnRpZmFjdFBhdGgpKTtcbiAgICAgICAgICBpZiAoZXhpc3RpbmdBc3NldCkge1xuICAgICAgICAgICAgZCgnYXNzZXQgYXQgcGF0aDonLCBhcnRpZmFjdFBhdGgsICdhbHJlYWR5IGV4aXN0cyBvbiBzZXJ2ZXInKTtcbiAgICAgICAgICAgIHVwbG9hZGVkICs9IDE7XG4gICAgICAgICAgICB1cGRhdGVTcGlubmVyKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgZCgnYXR0ZW1wdGluZyB0byB1cGxvYWQgYXNzZXQ6JywgYXJ0aWZhY3RQYXRoKTtcbiAgICAgICAgICBjb25zdCBhcnRpZmFjdEZvcm0gPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgICBhcnRpZmFjdEZvcm0uYXBwZW5kKCd0b2tlbicsIHRva2VuKTtcbiAgICAgICAgICBhcnRpZmFjdEZvcm0uYXBwZW5kKCd2ZXJzaW9uJywgcGFja2FnZUpTT04udmVyc2lvbik7XG4gICAgICAgICAgYXJ0aWZhY3RGb3JtLmFwcGVuZCgncGxhdGZvcm0nLCBlcnNQbGF0Zm9ybShwbGF0Zm9ybSwgYXJjaCkpO1xuICAgICAgICAgIGFydGlmYWN0Rm9ybS5hcHBlbmQoJ2ZpbGUnLCBmcy5jcmVhdGVSZWFkU3RyZWFtKGFydGlmYWN0UGF0aCkpO1xuICAgICAgICAgIGF3YWl0IGF1dGhGZXRjaCgnYXBpL2Fzc2V0Jywge1xuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBib2R5OiBhcnRpZmFjdEZvcm0sXG4gICAgICAgICAgICBoZWFkZXJzOiBhcnRpZmFjdEZvcm0uZ2V0SGVhZGVycygpLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGQoJ3VwbG9hZCBzdWNjZXNzZnVsIGZvciBhc3NldDonLCBhcnRpZmFjdFBhdGgpO1xuICAgICAgICAgIHVwbG9hZGVkICs9IDE7XG4gICAgICAgICAgdXBkYXRlU3Bpbm5lcigpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApKTtcbiAgfSk7XG59O1xuIl19