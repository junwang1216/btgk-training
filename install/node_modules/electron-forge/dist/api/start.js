'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _bluebird = require('bluebird');

require('colors');

var _child_process = require('child_process');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _oraHandler = require('../util/ora-handler');

var _oraHandler2 = _interopRequireDefault(_oraHandler);

var _readPackageJson = require('../util/read-package-json');

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

var _rebuild = require('../util/rebuild');

var _rebuild2 = _interopRequireDefault(_rebuild);

var _resolveDir = require('../util/resolve-dir');

var _resolveDir2 = _interopRequireDefault(_resolveDir);

var _forgeConfig = require('../util/forge-config');

var _forgeConfig2 = _interopRequireDefault(_forgeConfig);

var _hook = require('../util/hook');

var _hook2 = _interopRequireDefault(_hook);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @typedef {Object} StartOptions
 * @property {string} [dir=process.cwd()] The path to the electron forge project to run
 * @property {string} [appPath='.'] The path (relative to dir) to the electron app to run relative to the project directory
 * @property {boolean} [interactive=false] Whether to use sensible defaults or prompt the user visually
 * @property {boolean} [enableLogging=false] Enables advanced internal Electron debug calls
 * @property {Array<string>} [args] Arguments to pass through to the launched Electron application
 */

/**
 * Start an Electron application.
 *
 * @param {StartOptions} providedOptions - Options for the Publish method
 * @return {Promise} Will resolve when the application is launched
 */
exports.default = (() => {
  var _ref = (0, _bluebird.coroutine)(function* (providedOptions = {}) {
    // eslint-disable-next-line prefer-const, no-unused-vars
    var _Object$assign = (0, _assign2.default)({
      dir: process.cwd(),
      appPath: '.',
      interactive: false,
      enableLogging: false,
      args: [],
      runAsNode: false,
      inspect: false
    }, providedOptions);

    let dir = _Object$assign.dir,
        interactive = _Object$assign.interactive,
        enableLogging = _Object$assign.enableLogging,
        appPath = _Object$assign.appPath,
        args = _Object$assign.args,
        runAsNode = _Object$assign.runAsNode,
        inspect = _Object$assign.inspect;

    _oraHandler2.default.interactive = interactive;

    yield (0, _oraHandler2.default)('Locating Application', (0, _bluebird.coroutine)(function* () {
      dir = yield (0, _resolveDir2.default)(dir);
      if (!dir) {
        throw 'Failed to locate startable Electron application';
      }
    }));

    const packageJSON = yield (0, _readPackageJson2.default)(dir);

    if (!packageJSON.version) {
      throw `Please set your application's 'version' in '${dir}/package.json'.`;
    }

    const forgeConfig = yield (0, _forgeConfig2.default)(dir);

    yield (0, _rebuild2.default)(dir, packageJSON.devDependencies['electron-prebuilt-compile'], process.platform, process.arch, forgeConfig.electronRebuildConfig);

    const spawnOpts = {
      cwd: dir,
      stdio: 'inherit',
      env: (0, _assign2.default)({}, process.env, enableLogging ? {
        ELECTRON_ENABLE_LOGGING: true,
        ELECTRON_ENABLE_STACK_DUMPING: true
      } : {})
    };

    if (runAsNode) {
      spawnOpts.env.ELECTRON_RUN_AS_NODE = true;
    } else {
      delete spawnOpts.env.ELECTRON_RUN_AS_NODE;
    }

    if (inspect) {
      args = ['--inspect'].concat(args);
    }

    let spawned;

    yield (0, _hook2.default)(forgeConfig, 'generateAssets');

    yield (0, _oraHandler2.default)('Launching Application', (0, _bluebird.coroutine)(function* () {
      spawned = (0, _child_process.spawn)(process.execPath, [_path2.default.resolve(dir, 'node_modules/electron-prebuilt-compile/lib/cli'), appPath].concat(args), spawnOpts);
    }));

    return spawned;
  });

  return function () {
    return _ref.apply(this, arguments);
  };
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwaS9zdGFydC5qcyJdLCJuYW1lcyI6WyJwcm92aWRlZE9wdGlvbnMiLCJkaXIiLCJwcm9jZXNzIiwiY3dkIiwiYXBwUGF0aCIsImludGVyYWN0aXZlIiwiZW5hYmxlTG9nZ2luZyIsImFyZ3MiLCJydW5Bc05vZGUiLCJpbnNwZWN0IiwicGFja2FnZUpTT04iLCJ2ZXJzaW9uIiwiZm9yZ2VDb25maWciLCJkZXZEZXBlbmRlbmNpZXMiLCJwbGF0Zm9ybSIsImFyY2giLCJlbGVjdHJvblJlYnVpbGRDb25maWciLCJzcGF3bk9wdHMiLCJzdGRpbyIsImVudiIsIkVMRUNUUk9OX0VOQUJMRV9MT0dHSU5HIiwiRUxFQ1RST05fRU5BQkxFX1NUQUNLX0RVTVBJTkciLCJFTEVDVFJPTl9SVU5fQVNfTk9ERSIsImNvbmNhdCIsInNwYXduZWQiLCJleGVjUGF0aCIsInJlc29sdmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQTs7Ozs7Ozs7O0FBU0E7Ozs7Ozs7c0NBTWUsV0FBT0Esa0JBQWtCLEVBQXpCLEVBQWdDO0FBQzdDO0FBRDZDLHlCQUVnQyxzQkFBYztBQUN6RkMsV0FBS0MsUUFBUUMsR0FBUixFQURvRjtBQUV6RkMsZUFBUyxHQUZnRjtBQUd6RkMsbUJBQWEsS0FINEU7QUFJekZDLHFCQUFlLEtBSjBFO0FBS3pGQyxZQUFNLEVBTG1GO0FBTXpGQyxpQkFBVyxLQU44RTtBQU96RkMsZUFBUztBQVBnRixLQUFkLEVBUTFFVCxlQVIwRSxDQUZoQzs7QUFBQSxRQUV2Q0MsR0FGdUMsa0JBRXZDQSxHQUZ1QztBQUFBLFFBRWxDSSxXQUZrQyxrQkFFbENBLFdBRmtDO0FBQUEsUUFFckJDLGFBRnFCLGtCQUVyQkEsYUFGcUI7QUFBQSxRQUVORixPQUZNLGtCQUVOQSxPQUZNO0FBQUEsUUFFR0csSUFGSCxrQkFFR0EsSUFGSDtBQUFBLFFBRVNDLFNBRlQsa0JBRVNBLFNBRlQ7QUFBQSxRQUVvQkMsT0FGcEIsa0JBRW9CQSxPQUZwQjs7QUFXN0MseUJBQVNKLFdBQVQsR0FBdUJBLFdBQXZCOztBQUVBLFVBQU0sMEJBQVMsc0JBQVQsMkJBQWlDLGFBQVk7QUFDakRKLFlBQU0sTUFBTSwwQkFBV0EsR0FBWCxDQUFaO0FBQ0EsVUFBSSxDQUFDQSxHQUFMLEVBQVU7QUFDUixjQUFNLGlEQUFOO0FBQ0Q7QUFDRixLQUxLLEVBQU47O0FBT0EsVUFBTVMsY0FBYyxNQUFNLCtCQUFnQlQsR0FBaEIsQ0FBMUI7O0FBRUEsUUFBSSxDQUFDUyxZQUFZQyxPQUFqQixFQUEwQjtBQUN4QixZQUFPLCtDQUE4Q1YsR0FBSSxpQkFBekQ7QUFDRDs7QUFFRCxVQUFNVyxjQUFjLE1BQU0sMkJBQWVYLEdBQWYsQ0FBMUI7O0FBRUEsVUFBTSx1QkFBUUEsR0FBUixFQUFhUyxZQUFZRyxlQUFaLENBQTRCLDJCQUE1QixDQUFiLEVBQXVFWCxRQUFRWSxRQUEvRSxFQUF5RlosUUFBUWEsSUFBakcsRUFBdUdILFlBQVlJLHFCQUFuSCxDQUFOOztBQUVBLFVBQU1DLFlBQVk7QUFDaEJkLFdBQUtGLEdBRFc7QUFFaEJpQixhQUFPLFNBRlM7QUFHaEJDLFdBQUssc0JBQWMsRUFBZCxFQUFrQmpCLFFBQVFpQixHQUExQixFQUErQmIsZ0JBQWdCO0FBQ2xEYyxpQ0FBeUIsSUFEeUI7QUFFbERDLHVDQUErQjtBQUZtQixPQUFoQixHQUdoQyxFQUhDO0FBSFcsS0FBbEI7O0FBU0EsUUFBSWIsU0FBSixFQUFlO0FBQ2JTLGdCQUFVRSxHQUFWLENBQWNHLG9CQUFkLEdBQXFDLElBQXJDO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsYUFBT0wsVUFBVUUsR0FBVixDQUFjRyxvQkFBckI7QUFDRDs7QUFFRCxRQUFJYixPQUFKLEVBQWE7QUFDWEYsYUFBTyxDQUFDLFdBQUQsRUFBY2dCLE1BQWQsQ0FBcUJoQixJQUFyQixDQUFQO0FBQ0Q7O0FBRUQsUUFBSWlCLE9BQUo7O0FBRUEsVUFBTSxvQkFBUVosV0FBUixFQUFxQixnQkFBckIsQ0FBTjs7QUFFQSxVQUFNLDBCQUFTLHVCQUFULDJCQUFrQyxhQUFZO0FBQ2xEWSxnQkFBVSwwQkFBTXRCLFFBQVF1QixRQUFkLEVBQXdCLENBQUMsZUFBS0MsT0FBTCxDQUFhekIsR0FBYixFQUFrQixnREFBbEIsQ0FBRCxFQUFzRUcsT0FBdEUsRUFBK0VtQixNQUEvRSxDQUFzRmhCLElBQXRGLENBQXhCLEVBQXFIVSxTQUFySCxDQUFWO0FBQ0QsS0FGSyxFQUFOOztBQUlBLFdBQU9PLE9BQVA7QUFDRCxHIiwiZmlsZSI6ImFwaS9zdGFydC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29sb3JzJztcbmltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IGFzeW5jT3JhIGZyb20gJy4uL3V0aWwvb3JhLWhhbmRsZXInO1xuaW1wb3J0IHJlYWRQYWNrYWdlSlNPTiBmcm9tICcuLi91dGlsL3JlYWQtcGFja2FnZS1qc29uJztcbmltcG9ydCByZWJ1aWxkIGZyb20gJy4uL3V0aWwvcmVidWlsZCc7XG5pbXBvcnQgcmVzb2x2ZURpciBmcm9tICcuLi91dGlsL3Jlc29sdmUtZGlyJztcbmltcG9ydCBnZXRGb3JnZUNvbmZpZyBmcm9tICcuLi91dGlsL2ZvcmdlLWNvbmZpZyc7XG5pbXBvcnQgcnVuSG9vayBmcm9tICcuLi91dGlsL2hvb2snO1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXJ0T3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IFtkaXI9cHJvY2Vzcy5jd2QoKV0gVGhlIHBhdGggdG8gdGhlIGVsZWN0cm9uIGZvcmdlIHByb2plY3QgdG8gcnVuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW2FwcFBhdGg9Jy4nXSBUaGUgcGF0aCAocmVsYXRpdmUgdG8gZGlyKSB0byB0aGUgZWxlY3Ryb24gYXBwIHRvIHJ1biByZWxhdGl2ZSB0byB0aGUgcHJvamVjdCBkaXJlY3RvcnlcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2ludGVyYWN0aXZlPWZhbHNlXSBXaGV0aGVyIHRvIHVzZSBzZW5zaWJsZSBkZWZhdWx0cyBvciBwcm9tcHQgdGhlIHVzZXIgdmlzdWFsbHlcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2VuYWJsZUxvZ2dpbmc9ZmFsc2VdIEVuYWJsZXMgYWR2YW5jZWQgaW50ZXJuYWwgRWxlY3Ryb24gZGVidWcgY2FsbHNcbiAqIEBwcm9wZXJ0eSB7QXJyYXk8c3RyaW5nPn0gW2FyZ3NdIEFyZ3VtZW50cyB0byBwYXNzIHRocm91Z2ggdG8gdGhlIGxhdW5jaGVkIEVsZWN0cm9uIGFwcGxpY2F0aW9uXG4gKi9cblxuLyoqXG4gKiBTdGFydCBhbiBFbGVjdHJvbiBhcHBsaWNhdGlvbi5cbiAqXG4gKiBAcGFyYW0ge1N0YXJ0T3B0aW9uc30gcHJvdmlkZWRPcHRpb25zIC0gT3B0aW9ucyBmb3IgdGhlIFB1Ymxpc2ggbWV0aG9kXG4gKiBAcmV0dXJuIHtQcm9taXNlfSBXaWxsIHJlc29sdmUgd2hlbiB0aGUgYXBwbGljYXRpb24gaXMgbGF1bmNoZWRcbiAqL1xuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHByb3ZpZGVkT3B0aW9ucyA9IHt9KSA9PiB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItY29uc3QsIG5vLXVudXNlZC12YXJzXG4gIGxldCB7IGRpciwgaW50ZXJhY3RpdmUsIGVuYWJsZUxvZ2dpbmcsIGFwcFBhdGgsIGFyZ3MsIHJ1bkFzTm9kZSwgaW5zcGVjdCB9ID0gT2JqZWN0LmFzc2lnbih7XG4gICAgZGlyOiBwcm9jZXNzLmN3ZCgpLFxuICAgIGFwcFBhdGg6ICcuJyxcbiAgICBpbnRlcmFjdGl2ZTogZmFsc2UsXG4gICAgZW5hYmxlTG9nZ2luZzogZmFsc2UsXG4gICAgYXJnczogW10sXG4gICAgcnVuQXNOb2RlOiBmYWxzZSxcbiAgICBpbnNwZWN0OiBmYWxzZSxcbiAgfSwgcHJvdmlkZWRPcHRpb25zKTtcbiAgYXN5bmNPcmEuaW50ZXJhY3RpdmUgPSBpbnRlcmFjdGl2ZTtcblxuICBhd2FpdCBhc3luY09yYSgnTG9jYXRpbmcgQXBwbGljYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgZGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICAgIGlmICghZGlyKSB7XG4gICAgICB0aHJvdyAnRmFpbGVkIHRvIGxvY2F0ZSBzdGFydGFibGUgRWxlY3Ryb24gYXBwbGljYXRpb24nO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUGFja2FnZUpTT04oZGlyKTtcblxuICBpZiAoIXBhY2thZ2VKU09OLnZlcnNpb24pIHtcbiAgICB0aHJvdyBgUGxlYXNlIHNldCB5b3VyIGFwcGxpY2F0aW9uJ3MgJ3ZlcnNpb24nIGluICcke2Rpcn0vcGFja2FnZS5qc29uJy5gO1xuICB9XG5cbiAgY29uc3QgZm9yZ2VDb25maWcgPSBhd2FpdCBnZXRGb3JnZUNvbmZpZyhkaXIpO1xuXG4gIGF3YWl0IHJlYnVpbGQoZGlyLCBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXNbJ2VsZWN0cm9uLXByZWJ1aWx0LWNvbXBpbGUnXSwgcHJvY2Vzcy5wbGF0Zm9ybSwgcHJvY2Vzcy5hcmNoLCBmb3JnZUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcpO1xuXG4gIGNvbnN0IHNwYXduT3B0cyA9IHtcbiAgICBjd2Q6IGRpcixcbiAgICBzdGRpbzogJ2luaGVyaXQnLFxuICAgIGVudjogT2JqZWN0LmFzc2lnbih7fSwgcHJvY2Vzcy5lbnYsIGVuYWJsZUxvZ2dpbmcgPyB7XG4gICAgICBFTEVDVFJPTl9FTkFCTEVfTE9HR0lORzogdHJ1ZSxcbiAgICAgIEVMRUNUUk9OX0VOQUJMRV9TVEFDS19EVU1QSU5HOiB0cnVlLFxuICAgIH0gOiB7fSksXG4gIH07XG5cbiAgaWYgKHJ1bkFzTm9kZSkge1xuICAgIHNwYXduT3B0cy5lbnYuRUxFQ1RST05fUlVOX0FTX05PREUgPSB0cnVlO1xuICB9IGVsc2Uge1xuICAgIGRlbGV0ZSBzcGF3bk9wdHMuZW52LkVMRUNUUk9OX1JVTl9BU19OT0RFO1xuICB9XG5cbiAgaWYgKGluc3BlY3QpIHtcbiAgICBhcmdzID0gWyctLWluc3BlY3QnXS5jb25jYXQoYXJncyk7XG4gIH1cblxuICBsZXQgc3Bhd25lZDtcblxuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAnZ2VuZXJhdGVBc3NldHMnKTtcblxuICBhd2FpdCBhc3luY09yYSgnTGF1bmNoaW5nIEFwcGxpY2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIHNwYXduZWQgPSBzcGF3bihwcm9jZXNzLmV4ZWNQYXRoLCBbcGF0aC5yZXNvbHZlKGRpciwgJ25vZGVfbW9kdWxlcy9lbGVjdHJvbi1wcmVidWlsdC1jb21waWxlL2xpYi9jbGknKSwgYXBwUGF0aF0uY29uY2F0KGFyZ3MpLCBzcGF3bk9wdHMpO1xuICB9KTtcblxuICByZXR1cm4gc3Bhd25lZDtcbn07XG4iXX0=